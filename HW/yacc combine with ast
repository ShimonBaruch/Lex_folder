%token NUM ID
%left '+' '-'
%left '*' '/'
%{
    #include<stdio.h>
    #include<string.h>
    #include<stdlib.h>
    typedef struct node
    {
        char *token;
        struct node *left;
        struct node *right;
    } node;
    node *mknode(char *token, node *left, node *right);
    void printtree(node *tree, int tabs);
    #define YYSTYPE struct node*
%}

%token BOOL CHAR INT DOUBLE FLOAT STRING INT_PTR CHAR_PTR DOUBLE_PTR FLOAT_PTR
%token IF ELSE WHILE FOR VAR ARGS PUBLIC PRIVATE STATIC RETURN NULLPTR VOID DO
%token AND OR EQ NE LE GE LT GT PLUS MINUS TIMES DIVIDE NOT ADDR ASSIGN
%token INT_LIT STRING_LIT CHAR_LIT ID
%token SEMICOLON COMMA LBRACE RBRACE LPAREN RPAREN LBRACKET RBRACKET

%%

program:
    functions
    ;

functions:
    function
    | functions function
    ;

function:
    visibility type ID LPAREN parameters RPAREN static_opt LBRACE body RBRACE
    ;

visibility:
    PUBLIC
    | PRIVATE
    ;

type:
    BOOL
    | CHAR
    | INT
    | DOUBLE
    | FLOAT
    | STRING
    | INT_PTR
    | CHAR_PTR
    | DOUBLE_PTR
    | FLOAT_PTR
    | VOID
    ;

parameters:
    /* empty */
    | parameter_list
    ;

parameter_list:
    parameter
    | parameter_list COMMA parameter
    ;

parameter:
    type ID
    ;

static_opt:
    /* empty */
    | STATIC
    ;

body:
    declarations statements
    ;

declarations:
    /* empty */
    | declaration declarations
    ;

declaration:
    VAR type SEMICOLON var_list SEMICOLON
    ;

var_list:
    ID
    | var_list COMMA ID
    ;

statements:
    /* empty */
    | statement statements
    ;

statement:
    assignment SEMICOLON
    | function_call SEMICOLON
    | if_statement
    | while_statement
    | for_statement
    | do_while_statement
    | block
    | RETURN expression SEMICOLON
    ;

assignment:
    ID ASSIGN expression
    | STRING_LIT LBRACKET expression RBRACKET ASSIGN expression
    | TIMES ID ASSIGN expression
    ;

function_call:
    ID LPAREN args RPAREN
    ;

args:
    /* empty */
    | arg_list
    ;

arg_list:
    expression
    | arg_list COMMA expression
    ;

if_statement:
    IF LPAREN expression RPAREN statement
    | IF LPAREN expression RPAREN statement ELSE statement
    ;

while_statement:
    WHILE LPAREN expression RPAREN statement
    ;

for_statement:
    FOR LPAREN assignment SEMICOLON expression SEMICOLON assignment RPAREN statement
    ;

do_while_statement:
    DO statement WHILE LPAREN expression RPAREN SEMICOLON
    ;

block:
    LBRACE statements RBRACE
    ;

expression:
    INT_LIT
    | STRING_LIT
    | CHAR_LIT
    | ID
    | expression PLUS expression
    | expression MINUS expression
    | expression TIMES expression
    | expression DIVIDE expression
    | MINUS expression
    | NOT expression
    | expression EQ expression
    | expression NE expression
    | expression LE expression
    | expression GE expression
    | expression LT expression
    | expression GT expression
    | expression AND expression
    | expression OR expression
    | ADDR ID
    | TIMES ID
    | LPAREN expression RPAREN
    ;

s: assignments {printtree($1, -1); printf("\n");};
assignments: assign assignments {$$ = mknode("", $1, $2);}| {$$ = mknode("",NULL,NULL);};
assign: ID '=' expr ';' {$$ = mknode($2->token, $1, $3);};
expr: expr '+' expr {$$ = mknode($2->token, $1, $3);}
    |expr '-' expr {$$ = mknode($2->token, $1, $3);}
    |expr '*' expr {$$ = mknode($2->token, $1, $3);}
    |expr '/' expr {$$ = mknode($2->token, $1, $3);}
    |'(' expr ')' {$$ = mknode("", mknode("(", $2, NULL), mknode(")", NULL, NULL));}
    |ID {$$ = $1;}
    |NUM {$$ = $1;}; 

%%

#include "lex.yy.c"

int main() 
{
    return yyparse();
}

node *mknode(char *token,node *left,node *right) { 
    node *newnode = (node*)malloc(sizeof(node)); 
    char *newstr = (char*)malloc(sizeof(token) + 1); 
    strcpy(newstr,token); 
    newnode->left = left; 
    newnode->right = right; 
    newnode->token = newstr; 
    return newnode; 
}

void printtree(node *tree, int tabs){
    for(int i=0; i<tabs;i++,printf("\t"));
    if(strcmp(tree->token,""))
        printf("%s\n", tree->token);
    if(tree->left)
        printtree(tree->left, tabs+1);
    if(tree->right)
        printtree(tree->right, tabs+1);
}

int yyerror()
{
    printf("Couldn't finish parsing.\n");
    return 0;
}
